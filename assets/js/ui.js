(function (window, Cryptoloji, $, twemoji, undefined) {

  /*
    methods prefixed with _ are "private"
    to see exposed method goto bottom :)
  */

  //////////////////////////////////////////////////////////////////////////////
  // private var to store the emoji letter-set used to encyption animation
  var _emojiLetterSet = {'a': 'ðŸ‡¦', 'b': 'ðŸ‡§', 'c': 'ðŸ‡¨', 'd': 'ðŸ‡©', 'e': 'ðŸ‡ª', 'f': 'ðŸ‡«', 'g': 'ðŸ‡¬', 'h': 'ðŸ‡­', 'i': 'ðŸ‡®', 'j': 'ðŸ‡¯', 'k': 'ðŸ‡°', 'l': 'ðŸ‡±', 'm': 'ðŸ‡²', 'n': 'ðŸ‡³', 'o': 'ðŸ‡´', 'p': 'ðŸ‡µ', 'q': 'ðŸ‡¶', 'r': 'ðŸ‡·', 's': 'ðŸ‡¸', 't': 'ðŸ‡¹', 'u': 'ðŸ‡º', 'v': 'ðŸ‡»', 'w': 'ðŸ‡¼', 'x': 'ðŸ‡½', 'y': 'ðŸ‡¾', 'z': 'ðŸ‡¿',
                         '0': '0âƒ£', '1': '1âƒ£', '2': '2âƒ£', '3': '3âƒ£', '4': '4âƒ£', '5': '5âƒ£', '6': '6âƒ£', '7': '7âƒ£', '8': '8âƒ£', '9': '9âƒ£',
                         'symbol': 'ðŸ”£'}
  //
  // public methods
  //

  function decryptText () {
    var text = $('#decryption_input').attr('text')
    Cryptoloji.current.input = text

    console.debug('Chosen text:', Cryptoloji.current.input)
    text = CryptoLib.decrypt(Cryptoloji.current.input, Cryptoloji.current.key)
    console.debug('Decrypted text:', text)
    Cryptoloji.current.output = text
    $('#decryption_output').removeClass('placeholdit').text(text)
    Cryptoloji.stateman.emit('decrypt:show-reply')
  }

  function encryptText () {
    if (Cryptoloji.current.key) {
      var text = $('#encryption_input').val()
      if (text !== '' && !/^\s+$/.test(text)) {
        CryptoLib.generateEmojiSubsetFrom(Cryptoloji.current.key)
        Cryptoloji.current.input = text
        Cryptoloji.stateman.emit('encrypt:hide-output-placeholder')
        console.debug('Chosen text:', text)
        text = CryptoLib.encrypt(Cryptoloji.current.input, Cryptoloji.current.key)
        console.debug('Encrypted text:', text)
        Cryptoloji.current.output = text
        encryptTextAnimation(Cryptoloji.current.input, text)
        // text = toTwemoji(text)
        // $('#encryption_output').html(text)
        // $('.share_message_item').html(text)
        // Cryptoloji.stateman.emit('encrypt:show-share')
      }
    }
  }

  function encryptTextAnimation (text, emojiText) {
    console.log(text, emojiText)
    text = text.toLowerCase()
    var letterEmoji = _.map(text, function (c) {
      // escape space or newline
      if (c === '\n' || c === ' ') return c

      // remap 'strange' characters
      var pointC = punycode.ucs2.decode(c)[0]
      // a <- Ã  0ca 224 Ã¡ 1ca 225 Ã¢ 2ca 226 Ã£ 3ca 227 Ã¤ 4ca 228 Ã¥ 5ca 229 Ã¦ 6ca 230
      if (pointC >= 224 && pointC <= 230) c = 'a'
      // c <- Ã§ 7ca 231
      else if (pointC === 231) c = 'c'
      // d <- Ã° hda 240 Ã¾ vda 254
      else if (pointC === 240 || pointC === 254) c = 'd'
      // e <- Ã¨ 8ca 232 Ã© 9ca 233 Ãª bda 234 Ã« cda 235
      else if (pointC >= 232 && pointC <= 235) c = 'e'
      // i <- Ã¬ dda 236 Ã­ eda 237 Ã® fda 238 Ã¯ gda 239
      else if (pointC >= 236 && pointC <= 239) c = 'i'
      // n <- Ã± ida 241
      else if (pointC === 241) c = 'n'
      // o <- Ã² jda 242 Ã³ kda 243 Ã´ lda 244 Ãµ mda 245 Ã¶ nda 246 Ã¸ pda 248
      else if (pointC >= 242 && pointC <= 246 || pointC === 248) c = 'o'
      // u <- Ã¹ qda 249 Ãº rda 250 Ã» sda 251 Ã¼ tda 252
      else if (pointC >= 249 && pointC <= 252) c = 'u'
      // y <- Ã½ uda 253 Ã¿ wda 255
      else if (pointC === 253 || pointC === 255) c = 'y'

      // find the emoji letter corresponding to the current char
      var current = _emojiLetterSet[c]
      // return the image of emoji letter
      return current ? toTwemoji(current) : toTwemoji(_emojiLetterSet['symbol'])
    })
    letterEmoji = letterEmoji.join('')
    $('#encryption_output').html(letterEmoji)

    emojiText = toTwemoji(emojiText)
    setTimeout(function () {
      $('#encryption_output').html(emojiText)
      $('.share_message_item').html(emojiText)
      Cryptoloji.stateman.emit('encrypt:show-share')
    }, 1500)
  }

  function handleHeader () {
    Cryptoloji.stateman.on('header:show', function () {
      $("#header").show()
    })
    Cryptoloji.stateman.on('header:hide', function () {
      $("#header").hide()
    })
  }

  function selectKey (key) {
    Cryptoloji.current.key = key
    console.debug('Chosen key', key)
    $(".share_key_emoji-item").html(toTwemoji(key))
  }

  function showDecryptableText (text) {
    $('#decryption_input').html(toTwemoji(text))
                          .attr('text', text)
  }




  function handleSvgLoading () {
    function loadSvg (element, path) {
      $.get(path)
       .done(function (result) {
          // console.log(result)
          $(element).append(result.documentElement)
          Cryptoloji.stateman.emit('svg:loaded', path)
        })
       .fail(function () {
          console.error(this)
        })
    }
    $("div[data-svg*='assets/svg']").each(function () {
      var self = this
      var path = $(self).attr('data-svg')
      // console.log(self, path)
      loadSvg(self, path)
    })

  }

  function toTwemoji (text) {
    return twemoji.parse(text, {
      folder: 'svg',
      ext:    '.svg'
    })
  }

  //////////////////////////////////////////////////////////////////////////////

  Cryptoloji.UI = {
    decryptText: decryptText,
    encryptText: encryptText,
    handleHeader: handleHeader,
    handleSvgLoading: handleSvgLoading,
    selectKey: selectKey,
    showDecryptableText: showDecryptableText,
    toTwemoji: toTwemoji
  }
  
})(window, window.Cryptoloji, window.jQuery, window.twemoji);
